{% extends "base.html" %}

{% block title %}ç¼–è¾‘å™¨ - Hugo Blog ç®¡ç†{% endblock %}
{% block page_title %}æ–‡ç« ç¼–è¾‘å™¨{% endblock %}

{% block extra_head %}
<!-- Marked.js for Markdown rendering -->
<script src="https://cdn.jsdelivr.net/npm/marked@4.3.0/marked.min.js"></script>
<!-- Highlight.js for code syntax highlighting -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
<style>
    /* ç¼–è¾‘å™¨å®¹å™¨ */
    .editor-container {
        height: calc(100vh - 250px);
        min-height: 500px;
    }

    /* Textarea ç¼–è¾‘å™¨æ ·å¼ */
    #markdown-editor {
        width: 100%;
        height: 100%;
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', 'Consolas', 'source-code-pro', monospace;
        font-size: 14px;
        line-height: 1.6;
        padding: 1rem;
        border: 1px solid #e5e7eb;
        border-radius: 0.5rem;
        resize: none;
        outline: none;
        background: #ffffff;
    }

    #markdown-editor:focus {
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    /* é¢„è§ˆåŒºåŸŸæ ·å¼ */
    .preview-container {
        height: 100%;
        overflow-y: auto;
        padding: 1rem;
        border: 1px solid #e5e7eb;
        border-radius: 0.5rem;
        background: #ffffff;
    }

    /* Markdown å†…å®¹æ ·å¼ */
    .markdown-body {
        font-size: 16px;
        line-height: 1.6;
        color: #24292e;
    }

    .markdown-body h1 {
        font-size: 2em;
        font-weight: 600;
        margin-top: 24px;
        margin-bottom: 16px;
        padding-bottom: 0.3em;
        border-bottom: 1px solid #eaecef;
    }

    .markdown-body h2 {
        font-size: 1.5em;
        font-weight: 600;
        margin-top: 24px;
        margin-bottom: 16px;
        padding-bottom: 0.3em;
        border-bottom: 1px solid #eaecef;
    }

    .markdown-body h3 {
        font-size: 1.25em;
        font-weight: 600;
        margin-top: 24px;
        margin-bottom: 16px;
    }

    .markdown-body p {
        margin-top: 0;
        margin-bottom: 16px;
    }

    .markdown-body ul, .markdown-body ol {
        margin-top: 0;
        margin-bottom: 16px;
        padding-left: 2em;
    }

    .markdown-body li {
        margin-top: 0.25em;
    }

    .markdown-body pre {
        background-color: #f6f8fa;
        border-radius: 6px;
        padding: 16px;
        overflow: auto;
        margin-bottom: 16px;
    }

    .markdown-body code {
        background-color: rgba(175,184,193,0.2);
        padding: 0.2em 0.4em;
        border-radius: 6px;
        font-size: 85%;
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', 'Consolas', monospace;
    }

    .markdown-body pre code {
        background-color: transparent;
        padding: 0;
    }

    .markdown-body blockquote {
        margin: 0 0 16px 0;
        padding: 0 1em;
        color: #6a737d;
        border-left: 0.25em solid #dfe2e5;
    }

    .markdown-body a {
        color: #0366d6;
        text-decoration: none;
    }

    .markdown-body a:hover {
        text-decoration: underline;
    }

    .markdown-body table {
        border-collapse: collapse;
        margin-bottom: 16px;
        width: 100%;
    }

    .markdown-body table th,
    .markdown-body table td {
        border: 1px solid #dfe2e5;
        padding: 6px 13px;
    }

    .markdown-body table th {
        font-weight: 600;
        background-color: #f6f8fa;
    }

    .markdown-body img {
        max-width: 100%;
        height: auto;
    }

    .markdown-body hr {
        height: 0.25em;
        padding: 0;
        margin: 24px 0;
        background-color: #e1e4e8;
        border: 0;
    }

    /* å·¥å…·æ æŒ‰é’®æ ·å¼ */
    .toolbar-btn {
        padding: 0.5rem 1rem;
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 0.375rem;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 14px;
        color: #374151;
    }

    .toolbar-btn:hover {
        background: #f3f4f6;
        border-color: #d1d5db;
    }

    .toolbar-btn:active {
        background: #e5e7eb;
    }
</style>
{% endblock %}

{% block content %}
<div x-data="editor()" x-init="init()" x-cloak>
    <!-- å·¥å…·æ  -->
    <div class="bg-white rounded-lg shadow p-4 mb-4">
        <div class="flex items-center justify-between mb-4">
            <div class="flex items-center space-x-4">
                <div>
                    <label class="text-sm font-medium text-gray-700">å½“å‰æ–‡ä»¶:</label>
                    <span x-text="currentFile || 'æœªé€‰æ‹©æ–‡ä»¶'" class="ml-2 text-gray-600"></span>
                </div>
            </div>

            <div class="flex items-center space-x-2">
                <!-- å›¾ç‰‡ç®¡ç†æŒ‰é’® -->
                <button @click="showImageManager = !showImageManager"
                        class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                    </svg>
                    å›¾ç‰‡ç®¡ç†
                </button>

                <!-- ä¿å­˜æŒ‰é’® -->
                <button @click="saveFile"
                        :disabled="saving || !hasChanges"
                        :class="{'opacity-50 cursor-not-allowed': saving || !hasChanges}"
                        class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"/>
                    </svg>
                    <span x-text="saving ? 'ä¿å­˜ä¸­...' : (hasChanges ? 'ä¿å­˜ (Ctrl+S)' : 'å·²ä¿å­˜')"></span>
                </button>

                <!-- å‘å¸ƒæŒ‰é’® -->
                <button id="publish-btn"
                        @click="publishArticle"
                        :disabled="publishing || !currentFile"
                        :class="{
                            'opacity-50 cursor-not-allowed': publishing || !currentFile,
                            'bg-green-600 hover:bg-green-700': !isPublished,
                            'bg-gray-400 hover:bg-gray-500': isPublished
                        }"
                        class="px-4 py-2 text-white rounded-lg transition-colors flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                    </svg>
                    <span x-text="publishing ? 'å‘å¸ƒä¸­...' : (isPublished ? 'å·²å‘å¸ƒ' : 'å‘å¸ƒ')"></span>
                </button>

                <!-- å‘å¸ƒçŠ¶æ€æ˜¾ç¤º -->
                <div id="publish-status" class="text-sm"></div>
            </div>
        </div>

        <!-- å›¾ç‰‡ç®¡ç†é¢æ¿ -->
        <div x-show="showImageManager" x-transition class="border-t pt-4">
            <div class="flex items-center justify-between mb-4">
                <h3 class="font-semibold text-gray-900">å›¾ç‰‡ç®¡ç†</h3>
                <label class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg cursor-pointer transition-colors">
                    <input type="file" @change="uploadImage($event)" accept="image/*" class="hidden">
                    ä¸Šä¼ å›¾ç‰‡
                </label>
            </div>

            <!-- å›¾ç‰‡åˆ—è¡¨ -->
            <div class="grid grid-cols-4 gap-4">
                <template x-for="image in images" :key="image.name">
                    <div class="relative group">
                        <img :src="'/content/' + currentFile.replace(/[^/]+$/, '') + image.url"
                             :alt="image.name"
                             class="w-full h-32 object-cover rounded border border-gray-200">
                        <div class="absolute inset-0 bg-black bg-opacity-50 opacity-0 group-hover:opacity-100 transition-opacity rounded flex items-center justify-center z-10">
                            <button @click.prevent="copyImageUrl(image.url)"
                                    class="px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white text-sm rounded mr-2 cursor-pointer shadow-lg">
                                å¤åˆ¶é“¾æ¥
                            </button>
                        </div>
                        <div class="mt-1 text-xs text-gray-600 truncate" x-text="image.name"></div>
                    </div>
                </template>
            </div>

            <p x-show="images.length === 0" class="text-gray-500 text-center py-8">
                æš‚æ— å›¾ç‰‡ï¼Œç‚¹å‡»"ä¸Šä¼ å›¾ç‰‡"å¼€å§‹ä¸Šä¼ 
            </p>
        </div>
    </div>

    <!-- Markdown å·¥å…·æ  -->
    <div class="bg-white rounded-lg shadow p-3 mb-4">
        <div class="flex flex-wrap gap-2">
            <button @click="insertMarkdown('bold')" class="toolbar-btn" title="åŠ ç²— (Ctrl+B)">
                <strong>B</strong>
            </button>
            <button @click="insertMarkdown('italic')" class="toolbar-btn" title="æ–œä½“ (Ctrl+I)">
                <em>I</em>
            </button>
            <button @click="insertMarkdown('heading')" class="toolbar-btn" title="æ ‡é¢˜">
                H
            </button>
            <span class="border-l border-gray-300 mx-1"></span>
            <button @click="insertMarkdown('link')" class="toolbar-btn" title="é“¾æ¥">
                ğŸ”— é“¾æ¥
            </button>
            <button @click="insertMarkdown('image')" class="toolbar-btn" title="å›¾ç‰‡">
                ğŸ–¼ï¸ å›¾ç‰‡
            </button>
            <span class="border-l border-gray-300 mx-1"></span>
            <button @click="insertMarkdown('ul')" class="toolbar-btn" title="æ— åºåˆ—è¡¨">
                â€¢ åˆ—è¡¨
            </button>
            <button @click="insertMarkdown('ol')" class="toolbar-btn" title="æœ‰åºåˆ—è¡¨">
                1. åˆ—è¡¨
            </button>
            <button @click="insertMarkdown('quote')" class="toolbar-btn" title="å¼•ç”¨">
                " å¼•ç”¨
            </button>
            <button @click="insertMarkdown('code')" class="toolbar-btn" title="ä»£ç ">
                &lt;/&gt; ä»£ç 
            </button>
            <button @click="insertMarkdown('table')" class="toolbar-btn" title="è¡¨æ ¼">
                âŠ è¡¨æ ¼
            </button>
        </div>
    </div>

    <!-- ç¼–è¾‘å™¨å’Œé¢„è§ˆ -->
    <div class="bg-white rounded-lg shadow p-4">
        <div class="grid grid-cols-2 gap-4 editor-container">
            <!-- ç¼–è¾‘å™¨ -->
            <div>
                <div class="text-sm font-medium text-gray-700 mb-2">ç¼–è¾‘å™¨</div>
                <textarea
                    id="markdown-editor"
                    x-model="content"
                    @input="updatePreview(); checkChanges()"
                    placeholder="åœ¨æ­¤è¾“å…¥ Markdown å†…å®¹..."
                ></textarea>
            </div>

            <!-- é¢„è§ˆ -->
            <div>
                <div class="text-sm font-medium text-gray-700 mb-2">é¢„è§ˆ</div>
                <div class="preview-container">
                    <div class="markdown-body" x-html="preview"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- åŠ è½½çŠ¶æ€ -->
    <template x-if="loading">
        <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-lg p-8 text-center">
                <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mb-4"></div>
                <p class="text-gray-700">åŠ è½½ä¸­...</p>
            </div>
        </div>
    </template>
</div>

<script>
function editor() {
    return {
        currentFile: '{% if file_path %}{{ file_path }}{% endif %}',
        content: '',
        originalContent: '',
        preview: '',
        hasChanges: false,
        loading: false,
        saving: false,
        publishing: false,
        isPublished: false,
        showImageManager: false,
        images: [],

        async init() {
            // é…ç½® marked.js
            marked.setOptions({
                breaks: true,
                gfm: true,
                highlight: function(code, lang) {
                    if (lang && hljs.getLanguage(lang)) {
                        try {
                            return hljs.highlight(code, { language: lang }).value;
                        } catch (err) {}
                    }
                    return code;
                }
            });

            // å¦‚æœæœ‰æ–‡ä»¶è·¯å¾„ï¼ŒåŠ è½½æ–‡ä»¶
            if (this.currentFile) {
                await this.loadFile(this.currentFile);
                await this.loadImages();
            }

            // æ·»åŠ å¿«æ·é”®
            document.addEventListener('keydown', (e) => {
                if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                    e.preventDefault();
                    if (this.hasChanges && !this.saving) {
                        this.saveFile();
                    }
                }
                if ((e.ctrlKey || e.metaKey) && e.key === 'b') {
                    e.preventDefault();
                    this.insertMarkdown('bold');
                }
                if ((e.ctrlKey || e.metaKey) && e.key === 'i') {
                    e.preventDefault();
                    this.insertMarkdown('italic');
                }
            });
        },

        checkChanges() {
            this.hasChanges = this.content !== this.originalContent;
        },

        updatePreview() {
            // ç§»é™¤ frontmatter éƒ¨åˆ†ï¼ˆç”¨ --- åŒ…å›´çš„å…ƒæ•°æ®ï¼‰
            let contentWithoutFrontmatter = this.content || '';
            // åŒ¹é…å¼€å¤´çš„ frontmatterï¼š--- å¼€å§‹ï¼Œ--- ç»“æŸ
            const frontmatterRegex = /^---[\s\S]*?---\s*/;
            if (frontmatterRegex.test(contentWithoutFrontmatter)) {
                contentWithoutFrontmatter = contentWithoutFrontmatter.replace(frontmatterRegex, '');
            }

            // æ¸²æŸ“ Markdownï¼ˆä½¿ç”¨ç§»é™¤ frontmatter åçš„å†…å®¹ï¼‰
            let html = marked.parse(contentWithoutFrontmatter);

            // ä¿®å¤å›¾ç‰‡è·¯å¾„
            if (this.currentFile) {
                const articleDir = this.currentFile.replace(/[^/]+$/, '');
                html = html.replace(/<img\s+src="([^"]+)"/g, (match, src) => {
                    if (!src.startsWith('http://') && !src.startsWith('https://') && !src.startsWith('/')) {
                        src = `/content/${articleDir}${src}`;
                    }
                    return `<img src="${src}"`;
                });
            }

            this.preview = html;
        },

        insertMarkdown(type) {
            const textarea = document.getElementById('markdown-editor');
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const selectedText = this.content.substring(start, end);
            let insertion = '';
            let cursorOffset = 0;

            switch(type) {
                case 'bold':
                    insertion = `**${selectedText || 'ç²—ä½“æ–‡æœ¬'}**`;
                    cursorOffset = selectedText ? insertion.length : 2;
                    break;
                case 'italic':
                    insertion = `*${selectedText || 'æ–œä½“æ–‡æœ¬'}*`;
                    cursorOffset = selectedText ? insertion.length : 1;
                    break;
                case 'heading':
                    insertion = `## ${selectedText || 'æ ‡é¢˜'}`;
                    cursorOffset = selectedText ? insertion.length : 3;
                    break;
                case 'link':
                    insertion = `[${selectedText || 'é“¾æ¥æ–‡æœ¬'}](url)`;
                    cursorOffset = selectedText ? insertion.length - 4 : insertion.length - 5;
                    break;
                case 'image':
                    insertion = `![${selectedText || 'å›¾ç‰‡æè¿°'}](å›¾ç‰‡åœ°å€)`;
                    cursorOffset = selectedText ? insertion.length - 6 : insertion.length - 11;
                    break;
                case 'ul':
                    insertion = `- ${selectedText || 'åˆ—è¡¨é¡¹'}`;
                    cursorOffset = insertion.length;
                    break;
                case 'ol':
                    insertion = `1. ${selectedText || 'åˆ—è¡¨é¡¹'}`;
                    cursorOffset = insertion.length;
                    break;
                case 'quote':
                    insertion = `> ${selectedText || 'å¼•ç”¨å†…å®¹'}`;
                    cursorOffset = insertion.length;
                    break;
                case 'code':
                    if (selectedText.includes('\n')) {
                        insertion = `\`\`\`\n${selectedText || 'ä»£ç '}\n\`\`\``;
                        cursorOffset = selectedText ? insertion.length - 4 : 4;
                    } else {
                        insertion = `\`${selectedText || 'ä»£ç '}\``;
                        cursorOffset = selectedText ? insertion.length : 1;
                    }
                    break;
                case 'table':
                    insertion = `| åˆ—1 | åˆ—2 | åˆ—3 |\n| --- | --- | --- |\n| å†…å®¹ | å†…å®¹ | å†…å®¹ |`;
                    cursorOffset = insertion.length;
                    break;
            }

            this.content = this.content.substring(0, start) + insertion + this.content.substring(end);
            this.$nextTick(() => {
                textarea.focus();
                textarea.setSelectionRange(start + cursorOffset, start + cursorOffset);
                this.updatePreview();
                this.checkChanges();
            });
        },

        async loadFile() {
            this.loading = true;
            try {
                const response = await fetch('/api/file/read', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ path: this.currentFile })
                });

                const data = await response.json();
                if (data.success) {
                    this.content = data.content;
                    this.originalContent = data.content;
                    this.updatePreview();
                    this.hasChanges = false;

                    // åŠ è½½å‘å¸ƒçŠ¶æ€
                    await this.checkPublishStatus();
                } else {
                    utils.showNotification('åŠ è½½æ–‡ä»¶å¤±è´¥: ' + data.message, 'error');
                }
            } catch (error) {
                console.error('Failed to load file:', error);
                utils.showNotification('åŠ è½½æ–‡ä»¶å¤±è´¥', 'error');
            } finally {
                this.loading = false;
            }
        },

        async saveFile() {
            if (!this.currentFile) {
                utils.showNotification('æœªé€‰æ‹©æ–‡ä»¶', 'error');
                return;
            }

            this.saving = true;
            try {
                const response = await fetch('/api/file/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        path: this.currentFile,
                        content: this.content
                    })
                });

                const data = await response.json();
                if (data.success) {
                    this.originalContent = this.content;
                    this.hasChanges = false;
                    utils.showNotification('ä¿å­˜æˆåŠŸ', 'success');
                } else {
                    utils.showNotification('ä¿å­˜å¤±è´¥: ' + data.message, 'error');
                }
            } catch (error) {
                console.error('Failed to save file:', error);
                utils.showNotification('ä¿å­˜å¤±è´¥', 'error');
            } finally {
                this.saving = false;
            }
        },

        async publishArticle() {
            if (!this.currentFile) {
                utils.showNotification('æœªé€‰æ‹©æ–‡ä»¶', 'error');
                return;
            }

            // ç¡®è®¤å‘å¸ƒæ“ä½œ
            if (!confirm('ç¡®å®šè¦å‘å¸ƒè¿™ç¯‡æ–‡ç« å—ï¼Ÿå‘å¸ƒåå°†æ— æ³•æ’¤é”€è‰ç¨¿çŠ¶æ€ã€‚')) {
                return;
            }

            this.publishing = true;
            try {
                const response = await fetch('/api/article/publish', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        file_path: this.currentFile
                    })
                });

                const data = await response.json();
                if (data.success) {
                    this.isPublished = true;
                    utils.showNotification('æ–‡ç« å‘å¸ƒæˆåŠŸï¼', 'success');

                    // æ›´æ–°å‘å¸ƒçŠ¶æ€æ˜¾ç¤º
                    this.updatePublishStatus('success', 'æ–‡ç« å·²æˆåŠŸå‘å¸ƒ');
                } else {
                    utils.showNotification('å‘å¸ƒå¤±è´¥: ' + data.error, 'error');
                    this.updatePublishStatus('error', data.error);
                }
            } catch (error) {
                console.error('Failed to publish article:', error);
                utils.showNotification('å‘å¸ƒå¤±è´¥', 'error');
                this.updatePublishStatus('error', 'å‘å¸ƒè¯·æ±‚å¤±è´¥');
            } finally {
                this.publishing = false;
            }
        },

        async checkPublishStatus() {
            if (!this.currentFile) return;

            try {
                const response = await fetch(`/api/article/status?file_path=${encodeURIComponent(this.currentFile)}`);
                const data = await response.json();

                if (data.success) {
                    this.isPublished = !data.status.is_draft;
                }
            } catch (error) {
                console.error('Failed to check publish status:', error);
            }
        },

        updatePublishStatus(type, message) {
            const statusElement = document.getElementById('publish-status');
            if (statusElement) {
                if (type === 'success') {
                    statusElement.className = 'text-sm text-green-600 mt-1';
                    statusElement.textContent = message;
                } else if (type === 'error') {
                    statusElement.className = 'text-sm text-red-600 mt-1';
                    statusElement.textContent = message;
                } else {
                    statusElement.className = 'text-sm text-gray-600 mt-1';
                    statusElement.textContent = message;
                }

                // 3ç§’åæ¸…é™¤çŠ¶æ€æ¶ˆæ¯
                setTimeout(() => {
                    statusElement.textContent = '';
                }, 3000);
            }
        },

        async loadImages() {
            if (!this.currentFile) return;

            try {
                const response = await fetch('/api/image/list', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ article_path: this.currentFile })
                });

                const data = await response.json();
                if (data.success) {
                    this.images = data.images;
                }
            } catch (error) {
                console.error('Failed to load images:', error);
            }
        },

        async uploadImage(event) {
            const file = event.target.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append('file', file);
            formData.append('article_path', this.currentFile);

            try {
                const response = await fetch('/api/image/upload', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();
                if (data.success) {
                    utils.showNotification('å›¾ç‰‡ä¸Šä¼ æˆåŠŸ', 'success');
                    await this.loadImages();
                    event.target.value = '';
                } else {
                    utils.showNotification('ä¸Šä¼ å¤±è´¥: ' + data.message, 'error');
                }
            } catch (error) {
                console.error('Failed to upload image:', error);
                utils.showNotification('ä¸Šä¼ å¤±è´¥', 'error');
            }
        },

        copyImageUrl(imageUrl) {
            const markdownImage = `![](${imageUrl})`;

            // ä¼˜å…ˆä½¿ç”¨ç°ä»£ clipboard API
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(markdownImage).then(() => {
                    utils.showNotification('å·²å¤åˆ¶ Markdown å›¾ç‰‡è¯­æ³•', 'success');
                }).catch((err) => {
                    console.error('Failed to copy:', err);
                    // é™çº§åˆ°ä¼ ç»Ÿæ–¹æ³•
                    this.fallbackCopyToClipboard(markdownImage);
                });
            } else {
                // ä½¿ç”¨ä¼ ç»Ÿæ–¹æ³•
                this.fallbackCopyToClipboard(markdownImage);
            }
        },

        fallbackCopyToClipboard(text) {
            // ä¼ ç»Ÿçš„å¤åˆ¶æ–¹æ³•ï¼ˆå…¼å®¹æ€§æ›´å¥½ï¼‰
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            textArea.style.top = '-999999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();

            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    utils.showNotification('å·²å¤åˆ¶ Markdown å›¾ç‰‡è¯­æ³•', 'success');
                } else {
                    utils.showNotification('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶', 'error');
                }
            } catch (err) {
                console.error('Fallback copy failed:', err);
                utils.showNotification('å¤åˆ¶å¤±è´¥: ' + err.message, 'error');
            } finally {
                document.body.removeChild(textArea);
            }
        },

    };
}
</script>
{% endblock %}
